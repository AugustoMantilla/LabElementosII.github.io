<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>Práctica 4 | Ibero Puebla</title>
        <!-- Favicon-->
        <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
        <!-- Bootstrap icons-->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />
        <!-- Core theme CSS (includes Bootstrap)-->
        <link href="css/styles.css" rel="stylesheet" />

        <style>
            pre {
                background-color: #fefcfc;
                color: #373e43;
                padding: 15px;
                border-radius: 5px;
                overflow-x: auto;
                white-space: pre-wrap; /* Para que el código se ajuste al contenedor */
                font-size: 14px;
                line-height: 1;
            }
        </style>
    </head>
    <body class="d-flex flex-column h-100">
        <main class="flex-shrink-0">
            <!-- Navigation-->
            <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
                <div class="container px-5">
                    <a class="navbar-brand">Menu</a>
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
                    <div class="collapse navbar-collapse" id="navbarSupportedContent">
                        <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                            <li class="nav-item"><a class="nav-link" href="../">Home</a></li>                    
                            <li class="nav-item"><a class="nav-link" href="../index.html#resumen">Acerca de mi</a></li>
                            <li class="nav-item"><a class="nav-link" href="../index.html#practicas">Prácticas</a></li>
                        </ul>
                    </div>
                </div>
            </nav>

            <!-- Seccion TITULO de Portafolio-->
            <header class="bg-primary py-2 mt-6">
                <div class="container px-5">
                    <div class="row gx-5 align-items-center justify-content-center">
                        <div class="col-lg-8 col-xl-7 col-xxl-6">
                            <div class="my-5 text-center text-xl-start">
                                <h1 class="display-6 fw-bolder text-white mb-2">Portafolio de Actividades</h1>
                                <h1 class="display-8 fw-bolder text-white mb-2">Laboratorio Elementos Programables II</h1>
                                <p id="resumen" class="display-8 fw-normal text-white-50 mb-4">Departamento de Ciencias e Ingenierías | Universidad Iberoamericana Puebla, México.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Seccion TITULO de la Práctica-->
            <section class="py-3" id="scroll-target">
                <div class="container px-5 my-2">
                    <!-- Post header-->
                    <header class="mb-4">
                        <!-- Post title-->
                        <h1 class="fw-bolder mb-1">MQTT</h1>

                        <!-- ETIQUETA DE ALUMNO (Hacer una por cada alumno)-->
                            <div class="ms-2">
                                <div class="fw-bold">Augusto Mantilla Molina</div>
                                <div class="text-muted">Ingeniería Mecatrónica</div>
                            </div>

                            <div class="ms-2">
                                <div class="fw-bold">Carlos Juarez Galicia</div>
                                <div class="text-muted">Ingeniería Mecatrónica</div>
                            </div>
                        <!--Aqui termina etiqueta de alumno-->

                        <div class="text-muted fst-italic mt-2 mb-2">Fecha: Abril 10, 2025</div>
                        <!-- ETIQUETAS O TOPICOS IMPORTANTES DE LA PRACTICA-->
                        <a class="badge bg-primary text-decoration-none link-light" >ESP32</a>
                        <a class="badge bg-primary text-decoration-none link-light" >MQTT</a>

                    </header>
                </div>
            </section>

            <!-- Seccion de CONTENIDO de la Práctica-->
            <section>
                <div class="container px-5">

                    <figure class="mb-4"><img class="img-fluid rounded" width="800px" src="img/" alt="..." /></figure>
                        <p id="intro">
                        <h2 class="fw-bolder mb-4 mt-5 fs-5" >- Introducción -</h2>
                        <p class="fs-6 mb-4">
                            MQTT es un protocolo de mensajería ligero basado en el modelo publicador/suscriptor, diseñado para 
                            comunicaciones eficientes en redes con recursos limitados o anchos de banda reducidos.
                        </p>
                        <p class="fs-6 mb-4">
                            MQTT funciona a través de un broker que se encarga de distribuir los mensajes entre los dispositivos 
                            que publican (publishers) y los que están suscritos (subscribers) a un determinado tópico. Gracias a 
                            esta arquitectura, los dispositivos no necesitan conocerse directamente entre sí, lo que facilita la 
                            escalabilidad y flexibilidad en sistemas distribuidos.
                        </p>
                        <center><figure class="mb-4"><img class="img-fluid rounded" width="400px" src="img/mqtt.png" alt="..." /></figure></center>

                        <p id="materiales">
                        <h2 class="fw-bolder mb-4 mt-5 fs-5" >- Materiales -</h2>
                        <p class="fs-6 mb-4">
                            <ul>
                                <li><b>ESP32</b>: 1</li>
                                <li><b>Potenciómetro</b>: 1</li>
                                <li><b>Cables</b>: 3</li>
                            </ul>
                        </p>
                        <p id="desarrollo">
                        <h2 class="fw-bolder mb-4 mt-5 fs-5">- Desarrollo -</h2>
                        <p class="fs-6 mb-4">
                            La práctica realizada tuvo como objetivo explorar el funcionamiento del protocolo MQTT a través de 
                            una serie de pruebas tanto desde la computadora como desde un microcontrolador ESP32. La primera 
                            parte consistió en enviar datos desde la computadora a través de MQTT, midiendo el tiempo que tardaba 
                            un mensaje en ir y regresar. Para ello, se enviaron 1000 mensajes y se midió el tiempo individual de 
                            cada uno. Una vez obtenidos todos los datos, se calcularon el tiempo promedio, la desviación 
                            estándar, y se realizó una gráfica con los resultados.
                        </p>

                        <p class="fs-6 mb-4">
                            En la segunda parte de la práctica se repitió el mismo procedimiento, pero esta vez los mensajes 
                            fueron enviados desde un ESP32. Al igual que en el anterior, se registraron los tiempos de ida 
                            y vuelta para 1000 mensajes, y posteriormente se analizaron los datos obtenidos.
                        </p>
                        
                        <p class="fs-6 mb-4">
                            En la tercera parte, se implementó una comunicación en la que la computadora enviaba un mensaje 
                            mediante MQTT y el ESP32 lo recibía. Esta prueba permitió verificar la correcta recepción de mensajes 
                            en el microcontrolador desde un cliente MQTT ejecutado en la computadora.
                        </p>

                        <p class="fs-6 mb-4">
                            Finalmente, en la última parte de la práctica, se conectó un potenciómetro al ESP32 para enviar por 
                            MQTT los valores leídos de un potenciómetro. Esta información se transmitía de forma continua al broker MQTT, 
                            lo que permitió observar en tiempo real los datos generados por el sensor.
                        </p>
                            
                            <h1 class="fw-bolder2 mb-4 mt-5 fs-5"><b>Primera parte</b></h1>
                            <p class="fs-6 mb-4">
                                En Python se conecta al broker público test.mosquitto.org y mide el tiempo de ida y vuelta de 
                                10000 mensajes enviados al tópico "elementos2/augusto". Al recibir el mismo mensaje de vuelta, 
                                se calcula la latencia comparando el tiempo actual con el tiempo de envío. Todos los tiempos se 
                                almacenan en una lista para luego calcular el promedio y la desviación estándar. Finalmente, se 
                                genera una gráfica que muestra la latencia de cada mensaje, junto con líneas que indican el 
                                promedio y los límites de una desviación estándar.
                            </p>

                            <pre>
                                import paho.mqtt.client as mqtt
                                import time
                                import numpy as np
                                import matplotlib.pyplot as plt

                                # Configuración del broker MQTT
                                BROKER = "test.mosquitto.org"  # Puedes cambiarlo por tu broker
                                TOPIC = "elementos2/augusto"
                                NUM_MESSAGES = 10000  # Ajustado a 10000 para coincidir con la imagen

                                times = []  # Lista para almacenar los tiempos de ida y vuelta
                                sent_times = {}  # Diccionario para almacenar los tiempos de envío

                                def on_connect(client, userdata, flags, rc):
                                    print("Conectado al broker MQTT con código de resultado:", rc)
                                    client.subscribe(TOPIC)

                                def on_message(client, userdata, msg):
                                    global times
                                    receive_time = time.time()
                                    msg_id = int(msg.payload.decode())
                                    if msg_id in sent_times:
                                        round_trip_time = receive_time - sent_times[msg_id]
                                        times.append(round_trip_time)
                                        del sent_times[msg_id]  # Remover mensaje procesado

                                def main():
                                    client = mqtt.Client()
                                    client.on_connect = on_connect
                                    client.on_message = on_message
                                    client.connect(BROKER, 1883, 60)
                                    client.loop_start()
                                    
                                    print("Enviando mensajes...")
                                    for i in range(NUM_MESSAGES):
                                        sent_times[i] = time.time()
                                        client.publish(TOPIC, str(i))
                                        time.sleep(0.005)  # Reducida la pausa para más mensajes
                                    
                                    time.sleep(5)  # Esperar a recibir respuestas
                                    client.loop_stop()
                                    client.disconnect()
                                    
                                    if times:
                                        promedio = np.mean(times)
                                        desviacion = np.std(times)
                                        
                                        plt.figure(figsize=(10, 6))
                                        plt.scatter(range(len(times)), times, color='blue', s=1, alpha=0.6, label="Latency (s)")
                                        plt.axhline(promedio, color='green', linestyle='dashed', label=f'Mean = {promedio:.4f} s')
                                        plt.axhline(promedio + desviacion, color='orange', linestyle='dashed', label=f'+1 Std Dev = {promedio + desviacion:.4f} s')
                                        plt.axhline(promedio - desviacion, color='red', linestyle='dashed', label=f'-1 Std Dev = {promedio - desviacion:.4f} s')
                                        
                                        plt.xlabel("Message Index")
                                        plt.ylabel("Δt (s)")
                                        plt.title("MQTT Message Latency")
                                        plt.legend()
                                        plt.grid(True, linestyle='--', alpha=0.7)
                                        plt.show()
                                    else:
                                        print("No se recibieron respuestas.")

                                if __name__ == "__main__":
                                    main()
                            </pre>
                            <center><figure class="mb-4"><img class="img-fluid rounded" width="400px" src="img/primeraparte.png" alt="..." /></figure></center>
                            <p class="fs-6 mb-4">Descargar codigo: <a href="files/pracmqtt.py">Enviar datos a MQTT</a></p>

                            <h1 class="fw-bolder2 mb-4 mt-5 fs-5"><b>Segunda parte</b></h1>
                            <p class="fs-6 mb-4">
                                El ESP32 que se conecta al broker público test.mosquitto.org y mide la latencia de 5 mensajes 
                                enviados al tópico "elementos2/augusto/". Al recibir la respuesta, se calcula la latencia con la 
                                función millis(). Los resultados se imprimen por el puerto serial y al final se 
                                calcula el promedio y la desviación estándar de los tiempos obtenidos.
                            </p>

                            <pre>
                                #include <WiFi.h>           
                                #include <PubSubClient.h>

                                const char* ssid = "Guty";       
                                const char* password = "123456789";
                                const char* mqtt_broker = "test.mosquitto.org"; // Broker público

                                const char* topic = "elementos2/augusto/";
                                const int numMessages = 50;
                                unsigned long sendTimes[numMessages];
                                float latencies[numMessages];

                                WiFiClient espClient;
                                PubSubClient client(espClient);

                                void callback(char* topic, byte* payload, unsigned int length) {
                                    unsigned long receivedTime = millis();
                                    
                                    String message = "";
                                    for (int i = 0; i < length; i++) {
                                        message += (char)payload[i];
                                    }

                                    int index = message.substring(4).toInt();
                                    if (index >= 0 && index < numMessages) {
                                        latencies[index] = (receivedTime - sendTimes[index]) / 1000.0;
                                        Serial.printf("Mensaje %d recibido. Latencia: %.6f s\n", index, latencies[index]);
                                    } else {
                                        Serial.println("Mensaje fuera de rango recibido.");
                                    }
                                }


                                void setup_wifi() {
                                    WiFi.begin(ssid, password);
                                    while (WiFi.status() != WL_CONNECTED) {
                                        delay(500);
                                    }
                                }

                                void setup() {
                                    Serial.begin(115200);
                                    setup_wifi();
                                    client.setServer(mqtt_broker, 1883);
                                    client.setCallback(callback);
                                    client.connect("ArduinoClient");
                                    client.subscribe(topic);
                                }

                                void loop() {
                                    for (int i = 0; i < numMessages; i++) {
                                        String message = "msg_" + String(i);
                                        sendTimes[i] = millis();
                                        client.publish(topic, message.c_str());

                                        unsigned long startWait = millis();
                                        while (millis() - startWait < 200) {  // Esperar 200ms procesando MQTT
                                            client.loop();
                                        }
                                    }

                                    delay(5000);  // Esperar a que lleguen respuestas

                                    // Calcular latencia promedio
                                    float sum = 0, sumSq = 0;
                                    int receivedCount = 0;
                                    for (int i = 0; i < numMessages; i++) {
                                        if (latencies[i] > 0) {
                                            sum += latencies[i];
                                            sumSq += latencies[i] * latencies[i];
                                            receivedCount++;
                                        }
                                    }

                                    if (receivedCount > 0) {
                                        float mean = sum / receivedCount;
                                        float stddev = sqrt((sumSq / receivedCount) - (mean * mean));
                                        Serial.printf("Latencia promedio: %.6f s\n", mean);
                                        Serial.printf("Desviación estándar: %.6f s\n", stddev);
                                    } else {
                                        Serial.println("No se recibieron respuestas.");
                                    }

                                    while (true);
                                }
                            </pre>
                            <center><figure class="mb-4"><img class="img-fluid rounded" width="800px" src="img/parte2mqtt.png" alt="..." /></figure></center>
                            <p class="fs-6 mb-4">Descargar codigo: <a href="files/mqtt_esp32.ino">Enviar datos a MQTT con ESP32</a></p>

                            <h1 class="fw-bolder2 mb-4 mt-5 fs-5"><b>Tercera parte</b></h1>
                            <p class="fs-6 mb-4">
                                El ESP32 se conecta a una red WiFi y se suscribe al tópico "elementos2/augusto" a través del 
                                broker público test.mosquitto.org. Cada vez que recibe un mensaje en ese tópico, lo imprime por 
                                el puerto serial indicando el contenido del mensaje y el canal por el cual llegó.
                            </p>

                            <p class="fs-6 mb-4">
                                Además, desde la computadora se ejecuta un código en Python que actúa como cliente MQTT 
                                publicador. Este programa permite al usuario escribir mensajes desde la terminal, los cuales se 
                                envían al mismo tópico al que está suscrito el ESP32.
                            </p>
                            
                            <h2 class="fw-bolder mb-4 mt-5 fs-5"><b>ESP32</b></h2>
                            <pre>
                                #include <WiFi.h>
                                #include <PubSubClient.h>

                                // Configuración WiFi
                                const char* ssid = "Guty";  
                                const char* password = "123456789";

                                // Configuración del broker MQTT
                                const char* mqtt_server = "test.mosquitto.org";  
                                const char* topic = "elementos2/augusto";

                                WiFiClient espClient;
                                PubSubClient client(espClient);

                                // Función de conexión WiFi
                                void setup_wifi() {
                                    delay(10);
                                    //Serial.println("Conectando a WiFi...");
                                    WiFi.begin(ssid, password);
                                    while (WiFi.status() != WL_CONNECTED) {
                                        delay(500);
                                        Serial.print(".");
                                    }
                                    Serial.println("\nWiFi conectado.");
                                }

                                // Función de reconexión MQTT
                                void reconnect() {
                                    while (!client.connected()) {
                                        //Serial.print("Conectando a MQTT...");
                                        if (client.connect("ESP32_Client")) {
                                            //Serial.println("Conectado!");
                                            client.subscribe(topic);  // Suscripción al canal
                                        } else {
                                            //Serial.print("Falló. Código: ");
                                            //Serial.print(client.state());
                                            //Serial.println(" Intentando en 5 segundos...");
                                            delay(5000);
                                        }
                                    }
                                }

                                // Callback cuando se recibe un mensaje MQTT
                                void callback(char* topic, byte* payload, unsigned int length) {
                                    Serial.print("Mensaje recibido en el canal: ");
                                    Serial.println(topic);
                                    Serial.print("Contenido: ");
                                    for (unsigned int i = 0; i < length; i++) {
                                        Serial.print((char)payload[i]);
                                    }
                                    Serial.println();
                                }

                                void setup() {
                                    Serial.begin(115200);
                                    setup_wifi();
                                    client.setServer(mqtt_server, 1883);
                                    client.setCallback(callback);

                                    reconnect();  // Reconectar y suscribirse al canal
                                }

                                void loop() {
                                    if (!client.connected()) {
                                        reconnect();
                                    }
                                    client.loop();  // Mantener la conexión MQTT abierta
                                }
                            </pre>
                            <p class="fs-6 mb-4">Descargar codigo: <a href="files/python_mqtt_esp32.ino">Código recibir mensaje</a></p>

                            <h2 class="fw-bolder mb-4 mt-5 fs-5"><b>Python</b></h2>
                            <pre>
                                import paho.mqtt.client as mqtt

                                # Configuración del broker MQTT y canal
                                mqtt_broker = "test.mosquitto.org"
                                topic = "elementos2/augusto"

                                # Función que se ejecuta cuando el cliente se conecta al broker
                                def on_connect(client, userdata, flags, rc):
                                    print(f"Conectado al broker MQTT con código {rc}")
                                    print("Escribe un mensaje y presiona Enter para enviarlo (escribe 'exit' para salir):")

                                # Crear el cliente MQTT
                                client = mqtt.Client()

                                # Asignar la función de conexión
                                client.on_connect = on_connect

                                # Conectar al broker
                                client.connect(mqtt_broker, 1883, 60)

                                # Iniciar el loop en un hilo secundario para mantener la conexión activa
                                client.loop_start()

                                # Bucle para enviar mensajes desde la terminal
                                try:
                                    while True:
                                        mensaje = input("> ")  # Leer mensaje desde la terminal
                                        if mensaje.lower() == "exit":
                                            break  # Salir del programa si el usuario escribe 'exit'
                                        client.publish(topic, mensaje)  # Publicar el mensaje en MQTT
                                        print(f"Mensaje enviado: {mensaje}")

                                except KeyboardInterrupt:
                                    print("\nCerrando conexión...")

                                # Detener el loop y cerrar la conexión MQTT
                                client.loop_stop()
                                client.disconnect()
                                print("Desconectado del broker MQTT.")
                            </pre>
                            <p class="fs-6 mb-4">Descargar codigo: <a href="files/mqttaesp32.py">Código enviar mensaje</a></p>
                            <center><figure class="mb-4"><img class="img-fluid rounded" width="800px" src="img/parte3mqtt.png" alt="..." /></figure></center>


                            <h1 class="fw-bolder2 mb-4 mt-5 fs-5"><b>Cuarta parte</b></h1>
                            <p class="fs-6 mb-4">
                                El ESP32 se conecta a la red WiFi y al broker público test.mosquitto.org, y cada segundo publica 
                                el valor leído en el tópico "elementos2/augusto". El valor se envía como un mensaje de texto, y 
                                también se imprime por el puerto serial para su monitoreo.
                            </p>

                            <pre>
                                #include <WiFi.h>
                                #include <PubSubClient.h>

                                // WiFi
                                const char* ssid = "Guty";  
                                const char* password = "123456789";

                                // MQTT
                                const char* mqtt_server = "test.mosquitto.org";
                                const char* topic = "elementos2/augusto";

                                WiFiClient espClient;
                                PubSubClient client(espClient);

                                // Pin del potenciómetro
                                const int potPin = 4;

                                void setup() {
                                Serial.begin(115200);
                                delay(1000);

                                // Conexión WiFi
                                WiFi.begin(ssid, password);
                                Serial.print("Conectando a WiFi");
                                while (WiFi.status() != WL_CONNECTED) {
                                    delay(500);
                                    Serial.print(".");
                                }
                                Serial.println("\nConectado a WiFi");

                                // Configurar MQTT
                                client.setServer(mqtt_server, 1883);
                                reconnect();
                                }

                                void loop() {
                                if (!client.connected()) {
                                    reconnect();
                                }
                                client.loop();

                                // Leer el valor del potenciómetro
                                int potValue = analogRead(potPin);
                                char message[10];
                                sprintf(message, "%d", potValue);

                                // Enviar por MQTT
                                client.publish(topic, message);
                                Serial.print("Valor del potenciómetro enviado: ");
                                Serial.println(potValue);

                                delay(1000);  // Enviar cada 1 segundo
                                }

                                void reconnect() {
                                while (!client.connected()) {
                                    Serial.print("Conectando a MQTT...");
                                    if (client.connect("ESP32C6_PotClient")) {
                                    Serial.println("Conectado al broker MQTT");
                                    } else {
                                    Serial.print("Error, rc=");
                                    Serial.print(client.state());
                                    Serial.println(" reintentando en 5 segundos");
                                    delay(5000);
                                    }
                                }
                                }
                            </pre>
                            <p class="fs-6 mb-4">Descargar codigo: <a href="files/sensor.ino">Código enviar datos de potenciometro</a></p>
                            
                            <center><figure class="mb-4" align="center">
                                <video width="70%" height="500" controls>
                                    <source src="video/video mqtt.mp4"type=video/mp4">
                                </video>
                                </figure>
                            </center>
                            
                        <div>
                        <p id="conclusiones">
                        <h2 class="fw-bolder mb-4 mt-5 fs-5">- Conclusiones -</h2>
                        <p class="fs-6 mb-4">
                            La práctica permitió comprender el funcionamiento del protocolo MQTT mediante el envío y recepción de 
                            mensajes desde una computadora y un ESP32. Se logró medir la latencia de comunicación, visualizar su 
                            comportamiento estadístico y establecer una conexión efectiva entre ambos dispositivos. Además, se 
                            demostró cómo un microcontrolador puede enviar datos de sensores en tiempo real.
                        </p>

                        <p id="referencias">
                        <h2 class="fw-bolder mb-4 mt-5 fs-5">- Referencias -</h2>
                        <p class="fs-6 mb-4">Santos, S., & Santos, S. (2024, 24 octubre). ESP32 Pinout Reference: Which GPIO pins should you use? | Random Nerd Tutorials. Random Nerd Tutorials. <a href="https://randomnerdtutorials.com/esp32-pinout-reference-gpios/">https://randomnerdtutorials.com/esp32-pinout-reference-gpios/</a> </p>
                        
                        <p id="descargables">
                        <h2 class="fw-bolder mb-4 mt-5 fs-5">- Descargables -</h2>
                        <p class="fs-6 mb-4">ESP32 Datasheet: <a href="files/esp32-wroom-32_datasheet_en.pdf">ESP32.pdf</a> </p>
                </div>
            </section>

            
        </main>

        <!-- Footer-->
        <footer class="bg-dark py-4 mt-auto">
            <div class="container px-5">
                <div class="row align-items-center justify-content-between flex-column flex-sm-row">
                    <div class="col-auto"><div class="small m-0 text-white">Copyright &copy; Ingenierias-iberopuebla.mx 2023</div></div>
                    <div class="col-auto">
                        <a class="link-light small" href="#!">Privacy</a>
                        <span class="text-white mx-1">&middot;</span>
                        <a class="link-light small" href="#!">Terms</a>
                        <span class="text-white mx-1">&middot;</span>
                        <a class="link-light small" href="#!">Contact</a>
                    </div>
                </div>
            </div>
        </footer>

        <!-- Bootstrap core JS-->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Core theme JS-->
        <script src="js/scripts.js"></script>
    </body>
</html>
